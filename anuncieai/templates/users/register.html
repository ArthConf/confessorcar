{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="register-container">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="register-card">
                    <div class="row g-0">
                        <!-- Imagem de fundo à esquerda -->
                        <div class="col-md-5 register-banner">
                            <div class="overlay"></div>
                            <div class="banner-content">
                                <h2 class="welcome-title">Bem-vindo ao <span>AnuncieAI</span></h2>
                                <p>Sua plataforma para anúncios de veículos</p>
                                <div class="banner-icons">
                                    <div class="icon-item">
                                        <i class="fas fa-car"></i>
                                        <span>Anuncie seus veículos</span>
                                    </div>
                                    <div class="icon-item">
                                        <i class="fas fa-search"></i>
                                        <span>Encontre as melhores ofertas</span>
                                    </div>
                                    <div class="icon-item">
                                        <i class="fas fa-handshake"></i>
                                        <span>Negocie diretamente</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Formulário à direita -->
                        <div class="col-md-7">
                            <div class="register-form-container">
                                <div class="form-header">
                                    <h3>Criar sua conta</h3>
                                    <p>Preencha seus dados para se cadastrar</p>
                                </div>
                                
                                {% if messages %}
                                    {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                                
                                <!-- Erros de formulário visíveis -->
                                {% if form.errors %}
                                <div class="alert alert-danger">
                                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Por favor, corrija os seguintes erros:</h5>
                                    <ul class="mb-0">
                                        {% for field in form %}
                                            {% for error in field.errors %}
                                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                            {% endfor %}
                                        {% endfor %}
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                
                                <form method="post" class="needs-validation" novalidate id="registerForm">
                                    {% csrf_token %}
                                    
                                    <div class="row">
                                        <!-- Dados pessoais -->
                                        <div class="col-12 mb-3">
                                            <h5 class="form-section-title">Dados pessoais</h5>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }} <span class="text-danger">*</span></label>
                                            {{ form.first_name }}
                                            <div class="invalid-feedback">
                                                {{ form.first_name.errors }}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }} <span class="text-danger">*</span></label>
                                            {{ form.last_name }}
                                            <div class="invalid-feedback">
                                                {{ form.last_name.errors }}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.cpf.id_for_label }}" class="form-label">{{ form.cpf.label }} <span class="text-danger">*</span></label>
                                            {{ form.cpf }}
                                            <div class="invalid-feedback">
                                                {{ form.cpf.errors }}
                                            </div>
                                            <small class="form-text text-muted">{{ form.cpf.help_text }}</small>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.whatsapp.id_for_label }}" class="form-label">{{ form.whatsapp.label }}</label>
                                            {{ form.whatsapp }}
                                            <div class="invalid-feedback">
                                                {{ form.whatsapp.errors }}
                                            </div>
                                        </div>
                                        
                                        <!-- Endereço -->
                                        <div class="col-12 mb-3 mt-2">
                                            <h5 class="form-section-title">Endereço</h5>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label for="{{ form.cep.id_for_label }}" class="form-label">{{ form.cep.label }}</label>
                                            {{ form.cep }}
                                            <div class="invalid-feedback">
                                                {{ form.cep.errors }}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-8 mb-3">
                                            <label for="{{ form.endereco.id_for_label }}" class="form-label">{{ form.endereco.label }}</label>
                                            {{ form.endereco }}
                                            <div class="invalid-feedback">
                                                {{ form.endereco.errors }}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label for="{{ form.bairro.id_for_label }}" class="form-label">{{ form.bairro.label }}</label>
                                            {{ form.bairro }}
                                            <div class="invalid-feedback">
                                                {{ form.bairro.errors }}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label for="{{ form.estado.id_for_label }}" class="form-label">{{ form.estado.label }}</label>
                                            <div class="select-wrapper">
                                                {{ form.estado }}
                                                <span class="select-arrow"><i class="fas fa-chevron-down"></i></span>
                                            </div>
                                            <div class="invalid-feedback">
                                                {{ form.estado.errors }}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label for="{{ form.cidade.id_for_label }}" class="form-label">{{ form.cidade.label }}</label>
                                            <div class="select-wrapper cidade-wrapper">
                                                {{ form.cidade }}
                                                <span class="select-arrow"><i class="fas fa-chevron-down"></i></span>
                                            </div>
                                            <datalist id="cidade-list"></datalist>
                                            <div class="invalid-feedback">
                                                {{ form.cidade.errors }}
                                            </div>
                                        </div>
                                        
                                        <!-- Dados de acesso -->
                                        <div class="col-12 mb-3 mt-2">
                                            <h5 class="form-section-title">Dados de acesso</h5>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.username.id_for_label }}" class="form-label">{{ form.username.label }} <span class="text-danger">*</span></label>
                                            {{ form.username }}
                                            <div class="invalid-feedback">
                                                {{ form.username.errors }}
                                            </div>
                                            <small class="form-text text-muted">{{ form.username.help_text }}</small>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }} <span class="text-danger">*</span></label>
                                            {{ form.email }}
                                            <div class="invalid-feedback">
                                                {{ form.email.errors }}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.password1.id_for_label }}" class="form-label">{{ form.password1.label }} <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                {{ form.password1 }}
                                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="invalid-feedback">
                                                {{ form.password1.errors }}
                                            </div>
                                            
                                            <div class="password-strength-meter mt-2">
                                                <div class="password-requirements">
                                                    <p class="mb-1 text-muted">Requisitos de senha:</p>
                                                    <ul class="ps-4 mb-1 small">
                                                        <li id="req-length" class="password-req">
                                                            <i class="far fa-circle"></i> Pelo menos 8 caracteres
                                                        </li>
                                                        <li id="req-uppercase" class="password-req">
                                                            <i class="far fa-circle"></i> Pelo menos uma letra maiúscula
                                                        </li>
                                                        <li id="req-lowercase" class="password-req">
                                                            <i class="far fa-circle"></i> Pelo menos uma letra minúscula
                                                        </li>
                                                        <li id="req-number" class="password-req">
                                                            <i class="far fa-circle"></i> Pelo menos um número
                                                        </li>
                                                        <li id="req-special" class="password-req">
                                                            <i class="far fa-circle"></i> Pelo menos um caractere especial
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="strength-bar-container">
                                                    <div class="strength-bar" id="strength-bar"></div>
                                                </div>
                                                <p class="strength-text mb-0 small" id="strength-text">Força da senha: Muito fraca</p>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.password2.id_for_label }}" class="form-label">{{ form.password2.label }} <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                {{ form.password2 }}
                                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="invalid-feedback">
                                                {{ form.password2.errors }}
                                            </div>
                                            <div class="password-match mt-1 small" id="password-match"></div>
                                        </div>
                                        
                                        <div class="col-12 mb-3 mt-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="termsCheck" required>
                                                <label class="form-check-label" for="termsCheck">
                                                    Concordo com os <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Termos e Condições</a> e a <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Política de Privacidade</a>
                                                </label>
                                                <div class="invalid-feedback">
                                                    Você deve concordar antes de se registrar.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2 mt-4">
                                        <button type="submit" class="btn btn-register">Criar minha conta</button>
                                    </div>
                                    
                                    <div class="form-footer text-center mt-4">
                                        <p>Já tem uma conta? <a href="{% url 'users:login' %}" class="login-link">Faça login</a></p>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modais para Termos e Privacidade -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Termos e Condições</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4>Termos e Condições de Uso do AnuncieAI</h4>
                <p>Última atualização: {% now "d/m/Y" %}</p>
                
                <h5>1. Aceitação dos Termos</h5>
                <p>Ao acessar ou utilizar o AnuncieAI, você concorda com estes Termos e Condições. Se você não concorda com qualquer parte destes termos, por favor, não utilize nossos serviços.</p>
                
                <h5>2. Descrição do Serviço</h5>
                <p>O AnuncieAI é uma plataforma que conecta vendedores e compradores de veículos, permitindo que os usuários publiquem anúncios e naveguem por ofertas disponíveis.</p>
                
                <h5>3. Cadastro e Conta</h5>
                <p>Para utilizar todos os recursos do AnuncieAI, é necessário criar uma conta. Você é responsável por manter a confidencialidade de suas informações de login e por todas as atividades que ocorrem em sua conta.</p>
                
                <h5>4. Conteúdo do Usuário</h5>
                <p>Ao publicar conteúdo no AnuncieAI, você garante que possui os direitos necessários sobre esse conteúdo e que ele não viola direitos de terceiros.</p>
                
                <h5>5. Responsabilidades</h5>
                <p>O AnuncieAI não é responsável pela qualidade, segurança ou legalidade dos itens anunciados, pela veracidade das informações fornecidas pelos usuários ou pela capacidade dos usuários de comprar ou vender itens.</p>
                
                <h5>6. Alterações nos Termos</h5>
                <p>O AnuncieAI pode modificar estes termos a qualquer momento. Continuando a usar o serviço após as alterações, você concorda com os novos termos.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="privacyModalLabel">Política de Privacidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4>Política de Privacidade do AnuncieAI</h4>
                <p>Última atualização: {% now "d/m/Y" %}</p>
                
                <h5>1. Informações Coletadas</h5>
                <p>Coletamos informações pessoais como nome, e-mail, CPF, endereço e telefone para possibilitar o uso da plataforma e a comunicação entre usuários.</p>
                
                <h5>2. Uso das Informações</h5>
                <p>Utilizamos suas informações para fornecer e melhorar nossos serviços, processar transações, enviar notificações importantes e fornecer suporte ao cliente.</p>
                
                <h5>3. Compartilhamento de Informações</h5>
                <p>Podemos compartilhar informações com outros usuários quando necessário para facilitar transações. Não compartilhamos suas informações pessoais com terceiros para fins de marketing sem seu consentimento.</p>
                
                <h5>4. Segurança</h5>
                <p>Implementamos medidas de segurança para proteger suas informações pessoais contra acesso não autorizado e uso indevido.</p>
                
                <h5>5. Seus Direitos</h5>
                <p>Você tem o direito de acessar, corrigir ou excluir suas informações pessoais a qualquer momento. Para exercer esses direitos, entre em contato conosco.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --primary: #0a1e36;    /* Azul escuro do "Anuncie" */
    --secondary: #30c5f5;  /* Azul claro/ciano do "Ai" */
    --third: #0066cc;      /* Azul médio do gradiente */
    --racing-red: #ff0000; /* Vermelho racing */
    --text-light: #f8f9fa; /* Texto claro */
    --text-dark: #343a40;  /* Texto escuro */
    --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--third) 70%, var(--secondary) 100%);
    
    /* Cores para força da senha */
    --strength-very-weak: #dc3545;
    --strength-weak: #ffc107;
    --strength-medium: #fd7e14;
    --strength-strong: #20c997;
    --strength-very-strong: #198754;
}

/* Container geral */
.register-container {
    background-color: #f8f9fa;
    min-height: calc(100vh - 150px);
    display: flex;
    align-items: flex-start; /* Alterado para iniciar do topo */
    padding: 80px 0 20px 0; /* Ajustado padding para começar mais acima */
}

/* Card principal */
.register-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    margin-top: 0; /* Removido o margin-top negativo */
}

/* Parte esquerda - Banner */
.register-banner {
    background-image: url('{% static "img/car-banner.jpg" %}');
    background-size: cover;
    background-position: center;
    position: relative;
    min-height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.register-banner .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(10,30,54,0.9) 0%, rgba(0,102,204,0.8) 100%);
}

.banner-content {
    position: relative;
    z-index: 2;
    color: white;
    padding: 2rem;
    text-align: center;
}

.welcome-title {
    font-size: 2.4rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    color: white;
    line-height: 1.2;
}

.welcome-title span {
    background: linear-gradient(90deg, #fff 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: none;
    font-weight: 800;
}

.banner-content p {
    font-size: 1.1rem;
    margin-bottom: 2rem;
}

.banner-icons {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.icon-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    text-align: left;
}

.icon-item i {
    font-size: 1.8rem;
    color: var(--secondary);
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.15);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.icon-item:hover i {
    background: rgba(255,255,255,0.25);
    transform: scale(1.1);
}

.icon-item span {
    font-size: 1rem;
    font-weight: 500;
}

/* Parte direita - Formulário */
.register-form-container {
    padding: 2.5rem;
    height: 100%;
    overflow-y: auto;
    max-height: 700px;
    scrollbar-width: thin;
    scrollbar-color: var(--third) #f0f0f0;
}

.register-form-container::-webkit-scrollbar {
    width: 8px;
}

.register-form-container::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 10px;
}

.register-form-container::-webkit-scrollbar-thumb {
    background-color: var(--third);
    border-radius: 10px;
}

.form-header {
    text-align: center;
    margin-bottom: 2rem;
}

.form-header h3 {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.form-header p {
    color: #6c757d;
}

.form-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--third);
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
    margin-bottom: 1rem;
}

/* Elementos do formulário */
.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
}

.form-control {
    padding: 0.65rem;
    border-radius: 8px;
    border: 1px solid #ddd;
    transition: all 0.3s;
}

.form-control:focus {
    border-color: var(--third);
    box-shadow: 0 0 0 0.25rem rgba(0, 102, 204, 0.25);
}

.form-text {
    font-size: 0.75rem;
}

/* Select wrapper para estilização personalizada */
.select-wrapper {
    position: relative;
    display: block;
}

.select-arrow {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: #6c757d;
}

/* Melhoria para o select de estados */
#estado {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding-right: 30px;
    cursor: pointer;
    background-color: #fff;
}

/* Estilização para o input de cidade para parecer select */
.cidade-wrapper input {
    cursor: pointer;
    padding-right: 30px;
}

/* Datalist para cidades */
#cidade-list option {
    font-size: 0.9rem;
    padding: 10px;
    cursor: pointer;
}

/* Botão de registro */
.btn-register {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 0.8rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn-register:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    color: white;
}

/* Link para login */
.login-link {
    color: var(--third);
    font-weight: 500;
    text-decoration: none;
}

.login-link:hover {
    text-decoration: underline;
}

/* Validação */
.form-control.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Estilos para visibilidade de senha */
.toggle-password {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    border-color: #ddd;
    background-color: #f8f9fa;
}

.toggle-password:hover {
    background-color: #e9ecef;
    border-color: #ddd;
}

/* Medidor de força de senha */
.password-strength-meter {
    margin-top: 10px;
}

.strength-bar-container {
    height: 5px;
    background-color: #e9ecef;
    border-radius: 10px;
    margin-top: 10px;
    margin-bottom: 5px;
}

.strength-bar {
    height: 100%;
    border-radius: 10px;
    width: 0%;
    transition: width 0.3s, background-color 0.3s;
}

.strength-text {
    color: #6c757d;
    font-size: 0.8rem;
}

/* Cores para os requisitos de senha */
.password-requirements {
    margin-top: 5px;
}

.password-requirements ul {
    list-style-type: none;
    padding-left: 0;
    margin-bottom: 0;
    column-count: 2;
    column-gap: 15px;
}

.password-req {
    margin-bottom: 4px;
    transition: all 0.3s ease;
}

.password-req i {
    margin-right: 5px;
    transition: all 0.3s ease;
}

.password-req.valid {
    color: var(--strength-very-strong);
}

.password-req.valid i {
    color: var(--strength-very-strong);
}

/* Mensagem de correspondência de senhas */
.password-match {
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

/* Customização do checkbox */
.form-check-input {
    cursor: pointer;
    border-color: var(--third);
}

.form-check-input:checked {
    background-color: var(--third);
    border-color: var(--third);
}

.form-check-input:focus {
    border-color: var(--third);
    box-shadow: 0 0 0 0.25rem rgba(0, 102, 204, 0.25);
}

.form-check-label {
    cursor: pointer;
}

.form-check a {
    color: var(--third);
    text-decoration: none;
}

.form-check a:hover {
    text-decoration: underline;
}

/* Responsividade */
@media (max-width: 767px) {
    .register-banner {
        min-height: 250px;
    }
    
    .register-form-container {
        padding: 1.5rem;
        max-height: none;
    }
    
    .register-container {
        min-height: auto;
        padding-top: 20px;
    }
    
    .welcome-title {
        font-size: 2rem;
    }
    
    .password-requirements ul {
        column-count: 1;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Garantir que a página inicie no topo
    window.scrollTo(0, 0);
    
    // Focar no primeiro campo ao carregar a página
    document.getElementById('id_first_name').focus();
    
    // Limpar a seleção de estado para não iniciar com Acre (que é o primeiro)
    const estadoSelect = document.getElementById('estado');
    if (estadoSelect) {
        // Define uma opção vazia para forçar o usuário a selecionar
        if (estadoSelect.options[0].value === 'AC') {
            estadoSelect.selectedIndex = -1; // Desmarca qualquer opção selecionada
            // Adicionar opção vazia no início se não existir
            if (estadoSelect.options[0].value !== '') {
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.text = 'Selecione um estado';
                estadoSelect.prepend(emptyOption);
            }
            estadoSelect.value = ''; // Seleciona a opção vazia
        }
    }
    
    // Inicializar o validador de formulário do Bootstrap
    var forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                // Encontrar o primeiro elemento inválido e dar foco a ele
                const invalidElements = form.querySelectorAll(':invalid');
                if (invalidElements.length > 0) {
                    invalidElements[0].focus();
                    
                    // Scrollar para o elemento com animação
                    const elementRect = invalidElements[0].getBoundingClientRect();
                    const offset = elementRect.top + window.scrollY - 100;
                    window.scrollTo({
                        top: offset,
                        behavior: 'smooth'
                    });
                }
            }
            
            form.classList.add('was-validated');
        }, false);
        
        // Adicionar validação visual em tempo real
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (input.value) {
                    input.classList.add('is-valid');
                }
            });
        });
    });
    
    // Máscaras para campos
    const cpfInput = document.querySelector('.cpf-mask');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
            }
            
            e.target.value = value;
            
            // Validação visual do CPF
            if (value.length === 14) {
                cpfInput.classList.add('is-valid');
            } else {
                cpfInput.classList.remove('is-valid');
            }
        });
    }
    
    const cepInput = document.querySelector('.cep-mask');
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            
            if (value.length > 5) {
                value = value.replace(/(\d{5})(\d{1,3})/, '$1-$2');
            }
            
            e.target.value = value;
            
            // Validação visual do CEP
            if (value.length === 8) {
                cepInput.classList.add('is-valid');
            } else {
                cepInput.classList.remove('is-valid');
            }
        });
    }
    
    const phoneInput = document.querySelector('.phone-mask');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{5})(\d{1,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{1,5})/, '($1) $2');
            }
            
            e.target.value = value;
            
            // Validação visual do WhatsApp
            if (value.length >= 10) {
                phoneInput.classList.add('is-valid');
            } else if (value.length > 0) {
                phoneInput.classList.remove('is-valid');
            }
        });
    }
    
    // Implementação para carregamento de cidades
    if (estadoSelect && document.getElementById('cidade') && document.getElementById('cidade-list')) {
        const cidadeInput = document.getElementById('cidade');
        const cidadeDatalist = document.getElementById('cidade-list');
        
        // Estilizar o campo de cidade para parecer um select
        cidadeInput.addEventListener('focus', function() {
            if (this.value === '') {
                // Simular um clique para exibir as opções disponíveis
                this.click();
            }
        });
        
        // Função para carregar cidades por API
        function carregarCidadesPorEstado(estado) {
            if (!estado) return;
            
            // Limpar opções anteriores
            cidadeDatalist.innerHTML = '';
            
            // Mostrar indicador de carregamento
            cidadeInput.placeholder = 'Carregando cidades...';
            cidadeInput.disabled = true;
            
            fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${estado}/municipios?orderBy=nome`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao buscar cidades');
                    }
                    return response.json();
                })
                .then(cidades => {
                    // Organizar cidades em ordem alfabética
                    cidades.sort((a, b) => a.nome.localeCompare(b.nome));
                    
                    // Adicionar cidades ao datalist
                    cidades.forEach(cidade => {
                        const option = document.createElement('option');
                        option.value = cidade.nome;
                        cidadeDatalist.appendChild(option);
                    });
                    
                    // Restaurar placeholder e habilitar input
                    cidadeInput.placeholder = 'Digite ou selecione sua cidade';
                    cidadeInput.disabled = false;
                    
                    // Validação visual do estado
                    estadoSelect.classList.add('is-valid');
                    
                    // Se já tem um valor no campo cidade, tentar encontrá-lo nas opções
                    const cidadeAtual = cidadeInput.value;
                    if (cidadeAtual) {
                        const cidadeExiste = Array.from(cidadeDatalist.options).some(
                            option => option.value.toLowerCase() === cidadeAtual.toLowerCase()
                        );
                        
                        if (!cidadeExiste) {
                            cidadeInput.value = ''; // Limpar se a cidade não existir no estado
                        } else {
                            cidadeInput.classList.add('is-valid');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar cidades:', error);
                    cidadeInput.placeholder = 'Digite sua cidade';
                    cidadeInput.disabled = false;
                });
        }
        
        // Validação do campo cidade
        cidadeInput.addEventListener('change', function() {
            if (this.value.trim() !== '') {
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
            }
        });
        
        // Carregar cidades quando o estado mudar
        estadoSelect.addEventListener('change', function() {
            cidadeInput.value = ''; // Limpar cidade atual
            cidadeInput.classList.remove('is-valid');
            carregarCidadesPorEstado(this.value);
        });
        
        // Se já tiver um estado selecionado ao carregar a página
        if (estadoSelect.value) {
            carregarCidadesPorEstado(estadoSelect.value);
        }
    }
    
    // Visibilidade da senha
    const togglePasswordButtons = document.querySelectorAll('.toggle-password');
    togglePasswordButtons.forEach(button => {
        button.addEventListener('click', function() {
            const passwordField = this.previousElementSibling;
            const icon = this.querySelector('i');
            
            // Toggle tipo de campo
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });
    
    // Verificação de força da senha
    const passwordField = document.getElementById('id_password1');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    
    // Requisitos da senha
    const reqLength = document.getElementById('req-length');
    const reqUppercase = document.getElementById('req-uppercase');
    const reqLowercase = document.getElementById('req-lowercase');
    const reqNumber = document.getElementById('req-number');
    const reqSpecial = document.getElementById('req-special');
    
    if (passwordField && strengthBar && strengthText) {
        passwordField.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            let color = '';
            let text = '';
            
            // Verificar requisitos
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[^A-Za-z0-9]/.test(password);
            
            // Atualizar indicadores visuais dos requisitos
            updateRequirement(reqLength, hasLength);
            updateRequirement(reqUppercase, hasUppercase);
            updateRequirement(reqLowercase, hasLowercase);
            updateRequirement(reqNumber, hasNumber);
            updateRequirement(reqSpecial, hasSpecial);
            
            // Calcular força da senha
            if (password.length > 0) {
                // Comprimento mínimo (máx: 2 pontos)
                strength += Math.min(2, Math.floor(password.length / 4));
                
                // Variedade de caracteres
                if (hasUppercase) strength += 1;
                if (hasLowercase) strength += 1;
                if (hasNumber) strength += 1;
                if (hasSpecial) strength += 1;
                
                // Complexidade (todos os tipos = +1)
                if (hasUppercase && hasLowercase && hasNumber && hasSpecial) strength += 1;
                
                // Determinar cor e texto baseado na pontuação (máx: 7)
                if (strength <= 2) {
                    color = 'var(--strength-very-weak)';
                    text = 'Muito fraca';
                    width = '20%';
                } else if (strength <= 3) {
                    color = 'var(--strength-weak)';
                    text = 'Fraca';
                    width = '40%';
                } else if (strength <= 4) {
                    color = 'var(--strength-medium)';
                    text = 'Média';
                    width = '60%';
                } else if (strength <= 5) {
                    color = 'var(--strength-strong)';
                    text = 'Forte';
                    width = '80%';
                } else {
                    color = 'var(--strength-very-strong)';
                    text = 'Muito forte';
                    width = '100%';
                }
                
                // Se não cumpre os requisitos mínimos
                if (!(hasLength && hasUppercase && hasLowercase && hasNumber)) {
                    color = 'var(--strength-very-weak)';
                    if (text !== 'Muito fraca') {
                        text = 'Insuficiente';
                    }
                }
            } else {
                color = '#e9ecef';
                text = 'Nenhuma';
                width = '0%';
            }
            
            // Atualizar barra e texto
            strengthBar.style.width = width;
            strengthBar.style.backgroundColor = color;
            strengthText.textContent = 'Força da senha: ' + text;
            strengthText.style.color = color !== '#e9ecef' ? color : '#6c757d';
            
            // Validar visualmente o campo
            if (password.length > 0 && hasLength && hasUppercase && hasLowercase && hasNumber) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else if (password.length > 0) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
            }
        });
    }
    
    // Função para atualizar requisitos visuais
    function updateRequirement(element, isValid) {
        if (isValid) {
            element.classList.add('valid');
            element.querySelector('i').className = 'fas fa-check-circle';
        } else {
            element.classList.remove('valid');
            element.querySelector('i').className = 'far fa-circle';
        }
    }
    
    // Verificar se as senhas coincidem
    const passwordConfirmField = document.getElementById('id_password2');
    const passwordMatchText = document.getElementById('password-match');
    
    if (passwordField && passwordConfirmField && passwordMatchText) {
        const checkPasswordMatch = function() {
            if (passwordConfirmField.value) {
                if (passwordField.value === passwordConfirmField.value) {
                    passwordMatchText.textContent = 'Senhas conferem ✓';
                    passwordMatchText.style.color = 'var(--strength-very-strong)';
                    passwordConfirmField.classList.add('is-valid');
                    passwordConfirmField.classList.remove('is-invalid');
                } else {
                    passwordMatchText.textContent = 'Senhas não conferem ✗';
                    passwordMatchText.style.color = 'var(--strength-very-weak)';
                    passwordConfirmField.classList.add('is-invalid');
                    passwordConfirmField.classList.remove('is-valid');
                }
            } else {
                passwordMatchText.textContent = '';
                passwordConfirmField.classList.remove('is-valid', 'is-invalid');
            }
        };
        
        passwordField.addEventListener('input', checkPasswordMatch);
        passwordConfirmField.addEventListener('input', checkPasswordMatch);
    }
});
</script>
{% endblock %}